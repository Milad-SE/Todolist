@model proj.Models.TodoViewModel
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="todo-container">
    <form asp-action="addTask" method="post">
        <div class="input-form">
            <input type="text" id="task-name-input" data-translatable-attr="placeholder"
                data-key-attr="taskNamePlaceholder" asp-for="NewTask.Name"
                placeholder="عنوان وظیفه: (پروژه فردا)">
            <textarea id="task-desc-input" data-translatable-attr="placeholder" data-key-attr="taskDescPlaceholder"
                asp-for="NewTask.Description" placeholder="توضیحات کامل وظیفه و جزئیات..."></textarea>
            <button id="add-btn" data-translatable="true" data-key="addTaskBtn">اضافه کردن وظیفه</button>
        </div>
    </form>
    <ul id="todo-list">
        @foreach (var task in Model.Tasks)
        {
            <li id="task-@task.Id" class="@((task.Completed ? "completed" : ""))">

                <div class="task-content display-mode">
                    <div class="task-name">@task.Name</div>
                    <div class="task-description">@task.Description</div>
                </div>
                <form id="edit-form-@task.Id" asp-action="EditTask" method="post" class="edit-mode"
                    style="display:none; flex-grow: 1; gap: 10px; flex-direction: column;">

                    <input type="hidden" name="Id" value="@task.Id" />

                    <input type="text" name="Name" value="@task.Name" class="form-control" />

                    <textarea name="Description" class="form-control">@task.Description</textarea>

                    <div class="actions" style="margin-top: 5px;">

                        <button type="button" onclick="confirmSave(@task.Id)" class="action-btn save-btn" title="ذخیره">

                            <i class="fas fa-check"></i>

                        </button>

                        <button type="button" class="action-btn delete-btn cancel-btn" onclick="toggleEdit(@task.Id, false)"
                            title="انصراف"><i class="fas fa-times"></i></button>

                    </div>

                </form>
                <div class="actions display-mode">
                    @if (!task.Completed)
                    {
                        <button type="button" class="action-btn complete-btn" onclick="confirmComplete(@task.Id)">✓</button>

                        <button type="button" class="action-btn edit-btn" onclick="toggleEdit(@task.Id, true)">
                            <i class="fas fa-pen"></i>
                        </button>
                    }

                    <button type="button" class="action-btn delete-btn" onclick="confirmDelete(@task.Id)">✕</button>
                </div>
            </li>
        }
    </ul>
</div>

<script>
    const translations = {
        headerTitle: { fa: 'لیست انجام کارهای من', en: 'My To-Do List' },
        headerIcon: { fa: '⭐', en: '⭐' },
        themeBtnText: { fa: 'حالت شب', en: 'Dark Mode' },
        langBtnText: { fa: 'English', en: 'فارسی' },
        addTaskBtn: { fa: 'اضافه کردن وظیفه', en: 'Add Task' },
        task3NameHidden: { fa: 'این متن در حالت ویرایش دیده نمی‌شود', en: 'This text is hidden in edit mode' },
        task3DescHidden: { fa: 'توضیحات پنهان', en: 'Hidden description' },
        taskNamePlaceholder: { fa: 'عنوان وظیفه: (پروژه فردا)', en: 'Task Title (Project Tomorrow)' },
        taskDescPlaceholder: { fa: 'توضیحات کامل وظیفه و جزئیات...', en: 'Full task description and details...' },
        completeTitle: { fa: 'تکمیل', en: 'Complete' },
        editTitle: { fa: 'ویرایش', en: 'Edit' },
        saveTitle: { fa: 'ذخیره', en: 'Save' },
        deleteTitle: { fa: 'حذف', en: 'Delete' },
        pageTitle: { fa: 'لیست انجام کارها', en: 'To-Do List' },
        confirmDeleteTitle: { fa: 'حذف وظیفه؟', en: 'Delete Task?' },
        confirmDeleteText: { fa: 'ااین مورد برای همیشه پاک می‌شود', en: 'This item will be deleted forever!' },
        confirmSaveTitle: { fa: 'ذخیره تغییرات؟', en: 'Save changes?' },
        confirmCompleteTitle: { fa: 'وظیفه انجام شد؟', en: 'Task completed?' },
        yesBtn: { fa: 'بله', en: 'Yes' },
        noBtn: { fa: 'خیر', en: 'No' }
    };

    function updateLanguage(lang) {
        const html = document.documentElement;
        const body = document.body;
        const toggleBtn = document.getElementById('language-toggle');
        html.setAttribute('lang', lang);
        html.setAttribute('dir', lang === 'fa' ? 'rtl' : 'ltr');
        body.classList.remove('fa', 'en');
        body.classList.add(lang);

        document.querySelectorAll('[data-translatable="true"]').forEach(el => {
            const key = el.getAttribute('data-key');
            if (translations[key] && translations[key][lang]) {
                el.textContent = translations[key][lang];
            }
        });

        document.querySelectorAll('[data-translatable-attr]').forEach(el => {
            const attr = el.getAttribute('data-translatable-attr');
            const key = el.getAttribute('data-key-attr');
            if (translations[key] && translations[key][lang]) {
                el.setAttribute(attr, translations[key][lang]);
            }
        });

        if (document.getElementById('page-title')) document.getElementById('page-title').textContent = translations.pageTitle[lang];

        if (toggleBtn) {
            toggleBtn.setAttribute('data-current-lang', lang);
            toggleBtn.querySelector('[data-key="langBtnText"]').textContent = lang === 'fa' ? 'English' : 'فارسی';
        }

        const themeBtn = document.getElementById('theme-toggle');
        if (themeBtn) {
            const themeBtnText = themeBtn.querySelector('[data-key="themeBtnText"]');
            const isDarkMode = body.classList.contains('dark-mode');
            if (themeBtnText) {
                if (lang === 'fa') {
                    themeBtnText.textContent = isDarkMode ? 'حالت روز' : 'حالت شب';
                } else {
                    themeBtnText.textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
                }
            }
        }

        localStorage.setItem('appLang', lang);
    }

    const savedLang = localStorage.getItem('appLang') || 'fa';
    updateLanguage(savedLang);

    if (document.getElementById('language-toggle')) {
        document.getElementById('language-toggle').addEventListener('click', function () {
            const currentLang = this.getAttribute('data-current-lang');
            const newLang = currentLang === 'fa' ? 'en' : 'fa';
            updateLanguage(newLang);
        });
    }

    if (document.getElementById('theme-toggle')) {
        document.getElementById('theme-toggle').addEventListener('click', function () {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            const currentLang = localStorage.getItem('appLang') || 'fa';
            const icon = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
            const themeBtnText = this.querySelector('[data-key="themeBtnText"]');
            if (themeBtnText) {
                if (currentLang === 'fa') {
                    themeBtnText.textContent = isDarkMode ? 'حالت روز' : 'حالت شب';
                } else {
                    themeBtnText.textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
                }
            }
            this.querySelector('i').className = icon;
            localStorage.setItem('darkMode', isDarkMode ? 'true' : 'false');
        });
    }

    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        const themeToggleBtn = document.getElementById('theme-toggle');
        if (themeToggleBtn) {
            themeToggleBtn.querySelector('i').className = 'fas fa-sun';
            const currentLang = localStorage.getItem('appLang') || 'fa';
            const themeBtnText = themeToggleBtn.querySelector('[data-key="themeBtnText"]');
            if (themeBtnText) {
                themeBtnText.textContent = currentLang === 'fa' ? 'حالت روز' : 'Light Mode';
            }
        }
    }

    function toggleEdit(id, isEditMode) {
        const li = document.getElementById('task-' + id);
        const displayElements = li.querySelectorAll('.display-mode');
        const editModeElements = li.querySelectorAll('.edit-mode');
        if (isEditMode) {
            displayElements.forEach(el => el.style.setProperty('display', 'none', 'important'));
            editModeElements.forEach(el => el.style.setProperty('display', 'flex', 'important'));
            li.classList.add('editing');
        } else {
            displayElements.forEach(el => {
                el.style.display = el.classList.contains('actions') ? 'flex' : 'block';
            });
            editModeElements.forEach(el => el.style.display = 'none');
            li.classList.remove('editing');
        }
    }

    function confirmComplete(id) {
        const lang = localStorage.getItem('appLang') || 'fa';
        Swal.fire({
            title: translations.confirmCompleteTitle[lang],
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#6f42c1',
            cancelButtonColor: '#6c757d',
            confirmButtonText: translations.yesBtn[lang],
            cancelButtonText: translations.noBtn[lang]
        }).then((result) => {
            if (result.isConfirmed) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/Home/Complete/' + id;
                document.body.appendChild(form);
                form.submit();
            }
        });
    }

    function confirmDelete(id) {
        const lang = localStorage.getItem('appLang') || 'fa';
        Swal.fire({
            title: translations.confirmDeleteTitle[lang],
            text: translations.confirmDeleteText[lang],
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: translations.yesBtn[lang],
            cancelButtonText: translations.noBtn[lang]
        }).then((result) => {
            if (result.isConfirmed) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/Home/DeleteTask/' + id;
                document.body.appendChild(form);
                form.submit();
            }
        });
    }

    function confirmSave(id) {
        const lang = localStorage.getItem('appLang') || 'fa';
        Swal.fire({
            title: translations.confirmSaveTitle[lang],
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: translations.yesBtn[lang],
            cancelButtonText: translations.noBtn[lang]
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('edit-form-' + id).submit();
            }
        });
    }
</script>